<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
    
  10 Java虚拟机 - 
  
  </title>
  
  
  <link href="atom.xml" rel="alternate" title="" type="application/atom+xml">
    <link rel="stylesheet" href="asset/css/foundation.min.css" />
    <link rel="stylesheet" href="asset/css/docs.css" />
    <script src="asset/js/vendor/modernizr.js"></script>
    <script src="asset/js/vendor/jquery.js"></script>
  <script src="asset/highlightjs/highlight.pack.js"></script>
  <link href="asset/highlightjs/styles/github.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script>hljs.initHighlightingOnLoad();</script>
<script type="text/javascript">
  function before_search(){
    var searchVal = 'site: ' + document.getElementById('search_input').value;
    document.getElementById('search_q').value = searchVal;
    return true;
  }
</script>
  </head>
  <body class="antialiased hide-extras">
    
    <div class="marketing off-canvas-wrap" data-offcanvas>
      <div class="inner-wrap">


<nav class="top-bar docs-bar hide-for-small" data-topbar>


  <section class="top-bar-section">
  <div class="row">
      <div style="position: relative;width:100%;"><div style="position: absolute; width:100%;">
        <ul id="main-menu" class="left">
        
        <li id=""><a target="self" href="index.html">Home</a></li>
        
        <li id=""><a target="_self" href="archives.html">Archives</a></li>
        
        </ul>

        <ul class="right" id="search-wrap">
          <li>
<form target="_blank" onsubmit="return before_search();" action="https://google.com/search" method="get">
    <input type="hidden" id="search_q" name="q" value="" />
    <input tabindex="1" type="search" id="search_input"  placeholder="Search"/>
</form>
</li>
          </ul>
      </div></div>
  </div>
  </section>

</nav>

        <nav class="tab-bar show-for-small">
  <a href="javascript:void(0)" class="left-off-canvas-toggle menu-icon">
    <span> &nbsp; </span>
  </a>
</nav>

<aside class="left-off-canvas-menu">
      <ul class="off-canvas-list">
        
        <li><a target="self" href="index.html">Home</a></li>
        
        <li><a target="_self" href="archives.html">Archives</a></li>
        

    <li><label>Categories</label></li>

        
            <li><a href="%E5%BC%80%E5%8F%91%E8%89%BA%E6%9C%AF%E6%8E%A2%E7%B4%A2.html">开发艺术探索</a></li>
        
            <li><a href="%E8%BF%9B%E9%98%B6%E4%B9%8B%E5%85%89.html">进阶之光</a></li>
        
            <li><a href="%E8%BF%9B%E9%98%B6%E8%A7%A3%E5%AF%86.html">进阶解密</a></li>
         

      </ul>
    </aside>

<a class="exit-off-canvas" href="#"></a>


        <section id="main-content" role="main" class="scroll-container">
        
       

 <script type="text/javascript">
  $(function(){
    $('#menu_item_index').addClass('is_active');
  });
</script>
<div class="row">
  <div class="large-8 medium-8 columns">
      <div class="markdown-body article-wrap">
       <div class="article">
          
          <h1>10 Java虚拟机</h1>
     
        <div class="read-more clearfix">
          <span class="date">2019/03/27</span>

          <span>posted in&nbsp;</span> 
          
              <span class="posted-in"><a href='%E8%BF%9B%E9%98%B6%E8%A7%A3%E5%AF%86.html'>进阶解密</a></span>
           
         
          <span class="comments">
            

            
          </span>

        </div>
      </div><!-- article -->

      <div class="article-content">
      <h3 id="toc_0">10.1 概述</h3>

<h4 id="toc_1">10.1.1 Java虚拟机家族</h4>

<ol>
<li>HotSpot VM</li>
<li>J9 VM</li>
<li>Zing VM</li>
</ol>

<h4 id="toc_2">10.1.2 Java虚拟机执行流程</h4>

<p><img src="media/15537010008552/15748433740583.jpg" alt="" style="width:524px;"/><br/>
<img src="media/15537010008552/15748433876904.jpg" alt="" style="width:426px;"/></p>

<h3 id="toc_3">10.2 Java虚拟机结构</h3>

<p><img src="media/15537010008552/15748434308127.jpg" alt="" style="width:453px;"/></p>

<h4 id="toc_4">10.2.1 Class文件格式</h4>

<p><img src="media/15537010008552/15748435663601.jpg" alt="" style="width:654px;"/></p>

<h4 id="toc_5">10.2.2 类的生命周期</h4>

<p><strong>类的生命周期：</strong><br/>
一个Java文件，从<code>被加载到Java虚拟机内存中</code>到<code>从内存中卸载</code>的过程。</p>

<ol>
<li>加载：查找并加载Class文件。</li>
<li>链接
<ol>
<li>验证：确保被导入类型的正确性。</li>
<li>准备：为类的静态字段分配字段，并用默认值初始化这些字段。</li>
<li>解析：虚拟机将常量池内的符号引用替换为直接引用。</li>
</ol></li>
<li>初始化：将类变量初始化为正确的初始值。</li>
<li>使用</li>
<li>卸载</li>
</ol>

<p><img src="media/15537010008552/15748439274778.jpg" alt="" style="width:386px;"/></p>

<h4 id="toc_6">10.2.3 类加载子系统</h4>

<p>类加载子系统通过多种类加载器来查找和加载Class文件到Java虚拟机中。Java虚拟机有两种你那个类加载器：系统加载器和自定义加载器。</p>

<p><strong>系统加载器：</strong></p>

<ol>
<li>Bootstrap ClassLoader（引导类加载器）</li>
<li>Extensions ClassLoader（拓展类加载器）</li>
<li>Application ClassLoader（应用程序类加载器）</li>
</ol>

<h4 id="toc_7">10.2.4 运行时数据区域</h4>

<ol>
<li>程序计数器 </li>
<li>Java虚拟机栈</li>
<li>本地方法栈</li>
<li>Java堆</li>
<li>方法区</li>
<li>运行时常量池</li>
<li>直接内存</li>
</ol>

<h3 id="toc_8">10.3 对象的创建</h3>

<ol>
<li>判断对象对应的类是否加载、链接和初始化</li>
<li>为对象分配内存
<ol>
<li>指针碰撞</li>
<li>空闲列表</li>
</ol></li>
<li>处理并发安全问题
<ol>
<li>分配内存进行同步处理</li>
<li>本地线程分配缓冲</li>
</ol></li>
<li>初始化分配到的内存空间</li>
<li>设置对象的对象头</li>
<li>执行init方法进行初始化</li>
</ol>

<h3 id="toc_9">10.4 对象的堆内存布局</h3>

<p>以HotSpot虚拟机为例，对象在堆内存的布局分为三个区域，分别是对象头（Header）、实例数据（Instance Data）、对齐填充（Padding）。</p>

<p><img src="media/15537010008552/15748470536456.jpg" alt="" style="width:191px;"/></p>

<h3 id="toc_10">10.5 oop-klass模型</h3>

<p>oop-klass模型模型是用来描述Java对象实例的一种模型，它分为两个部分，OOP（Ordinary  Object Pointer）指普通对象指针，用来表示对象的实例信息。klass用来描述元数据。</p>

<p><img src="media/15537010008552/15748473947755.jpg" alt="" style="width:426px;"/></p>

<h3 id="toc_11">10.6 垃圾标记算法</h3>

<h4 id="toc_12">10.6.1 Java中的引用</h4>

<ol>
<li>强引用：新建对象时引用，不会回收。</li>
<li>软引用：SoftReference，内存不足时回收。</li>
<li>弱引用：WeakReference，GC时回收。</li>
<li>虚引用：PhantomReference，和对象生命周期没有关系；被回收时会收到一个系统通知。</li>
</ol>

<h4 id="toc_13">10.6.2 引用计数算法</h4>

<p>基本思想：背个对象都有一个引用计数器，当对象在某处类引用的时候，它的引用计数器加1，引用失效时减1。当引用计数器中的值为0，则该对象就不能被使用，变成了垃圾。</p>

<p>目前主流Java虚拟机并没有选择使用引用计数算法，因为它没有解决对象之间互相循环引用的问题。</p>

<h4 id="toc_14">10.6.3 根搜索算法</h4>

<p>思想：选定一些对象作为GC Roots，并组成根对象集合，然后以这些GC Roots的对象作为起始点，向下搜索，如果目标对象到GC Roots是连接着的，我们则称为该对象是可达的，如果不可达则说说明目标对象是可以被回收的对象。如图：</p>

<p><img src="media/15537010008552/15748489005643.jpg" alt="" style="width:490px;"/></p>

<p>在Java中，可以作为GC Roots的对象主要有以下几种：</p>

<ul>
<li>Java栈中引用的对象。</li>
<li>本地方法栈中JNI引用的对象。</li>
<li>方法区中运行时常量池引用的对象。</li>
<li>方法区中静态属性引用的对象。</li>
<li>运行中的线程。</li>
<li>由引导类加载器加载的对象。</li>
<li>GC控制的对象。</li>
</ul>

<h3 id="toc_15">10.7 Java对象在虚拟机中的生命周期</h3>

<ol>
<li>创建阶段（Created）
<ol>
<li>为对象分配存储空间</li>
<li>构造对象</li>
<li>从超类到子类对static成员进行初始化</li>
<li>递归调用超类的构造方法</li>
<li>调用子类的构造方法</li>
</ol></li>
<li>应用阶段（In Use）</li>
<li>不可见阶段（Invisible）</li>
<li>不可达阶段（Unreachable）</li>
<li>收集阶段（Collected）</li>
<li>终结阶段（Finalized）</li>
<li>对象空间重新分配阶段（Deallocated）</li>
</ol>

<h3 id="toc_16">10.8 垃圾收集算法</h3>

<h4 id="toc_17">10.8.1 标记—清除算法</h4>

<ul>
<li>标记阶段：标记处可以回收的对象</li>
<li>清除阶段：回收被标记的对象所占的空间。</li>
</ul>

<p><img src="media/15537010008552/15749105545929.jpg" alt="" style="width:435px;"/></p>

<p><strong>缺点：</strong></p>

<ul>
<li>标记和清除的效率不高。</li>
<li>容易产生大量不连续的内存碎片，碎片太多可能导致没有足够的连续内存分配给较大对象，从而触发新的一次垃圾收集动作。</li>
</ul>

<h4 id="toc_18">10.8.2 复制算法</h4>

<p>为了解决标记—清除算法效率不高的问题。</p>

<ol>
<li>它把内存空间划分为两个相等的区域，每次只使用其中一个区域；</li>
<li>在垃圾收集时，遍历当前使用的区域，把存活的对象复制到另一个区域中，最后将当前使用的区域的可回收对象进行回收。</li>
</ol>

<p><img src="media/15537010008552/15749108305016.jpg" alt="" style="width:400px;"/></p>

<ul>
<li>这种算法每次对整个半区进行内存回收，不需要考虑内存碎片问题，代价就是使用内存为原来的一般。</li>
<li>复制算法的效率与存活对象数目有很大关系，如果存活对象很少，复制算法的效率就会很高。所以复制算法广泛应用于新生代中。</li>
</ul>

<h4 id="toc_19">10.8.3 标记-压缩算法</h4>

<p>老年代不适用复制算法，因为老年代对象存活率高，会有很多复制操作，导致效率变低。</p>

<p>标记-压缩算法在标记可回收的对象后，将所有存活的对象压缩到内存的另一端，使他们紧凑地排列在一起，然后对边界以外的内存进行回收。</p>

<p><img src="media/15537010008552/15749117879560.jpg" alt="" style="width:394px;"/></p>

<h4 id="toc_20">10.8.4 分代收集算法</h4>

<p>对不同生命周期的对象采取不同的收集算法，这就是分代的概念。</p>

<ul>
<li>新生代
<ul>
<li>Eden空间</li>
<li>From Survivor空间</li>
<li>To Survivor空间</li>
</ul></li>
<li>老年代</li>
</ul>

<p>Eden空间中大多数对象生命周期很短，Eden空间和两个Survivor空间所占比例为8:1。</p>

<p>根据Java堆区的空间划分，垃圾收集的类型分为两种：</p>

<ul>
<li>Minor Collection：新生代垃圾收集</li>
<li>Full Collection ：老年代收集。又称Major Collection。</li>
</ul>

<p>Full Collection通常情况下伴随至少一次的Minor Collection，收集频率较低，耗时较长。</p>

<p><img src="media/15537010008552/15749127215885.jpg" alt="" style="width:426px;"/></p>

<h3 id="toc_21">10.9 本章小结</h3>


    

      </div>

      <div class="row">
        <div class="large-6 columns">
        <p class="text-left" style="padding:15px 0px;">
      
          <a href="15518627703620.html" 
          title="Previous Post: 10 Android的消息机制">&laquo; 10 Android的消息机制</a>
      
        </p>
        </div>
        <div class="large-6 columns">
      <p class="text-right" style="padding:15px 0px;">
      
          <a  href="15536971381446.html" 
          title="Next Post: 10 应用架构设计">10 应用架构设计 &raquo;</a>
      
      </p>
        </div>
      </div>
      <div class="comments-wrap">
        <div class="share-comments">
          

          

          
        </div>
      </div>
    </div><!-- article-wrap -->
  </div><!-- large 8 -->




 <div class="large-4 medium-4 columns">
  <div class="hide-for-small">
    <div id="sidebar" class="sidebar">
          <div id="site-info" class="site-info">
            
                <h1></h1>
                <div class="site-des"></div>
                <div class="social">











  <a target="_blank" class="rss" href="atom.xml" title="RSS">RSS</a>
                
              	 </div>
          	</div>

             

              <div id="site-categories" class="side-item ">
                <div class="side-header">
                  <h2>Categories</h2>
                </div>
                <div class="side-content">

      	<p class="cat-list">
        
            <a href="%E5%BC%80%E5%8F%91%E8%89%BA%E6%9C%AF%E6%8E%A2%E7%B4%A2.html"><strong>开发艺术探索</strong></a>
        
            <a href="%E8%BF%9B%E9%98%B6%E4%B9%8B%E5%85%89.html"><strong>进阶之光</strong></a>
        
            <a href="%E8%BF%9B%E9%98%B6%E8%A7%A3%E5%AF%86.html"><strong>进阶解密</strong></a>
         
        </p>


                </div>
              </div>

              <div id="site-categories" class="side-item">
                <div class="side-header">
                  <h2>Recent Posts</h2>
                </div>
                <div class="side-content">
                <ul class="posts-list">
	      
		      
			      <li class="post">
			        <a href="15789721660565.html">0 Android开发艺术探索-目录</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="15789731325545.html">0 Android进阶之光-目录</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="15789733843338.html">0 Android进阶解密-目录</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="15511960673056.html">01 Activity的生命周期和启动模式</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="15536968610805.html">01 Android新特性</a>
			      </li>
		     
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		   
		  		</ul>
                </div>
              </div>
        </div><!-- sidebar -->
      </div><!-- hide for small -->
</div><!-- large 4 -->

</div><!-- row -->

 <div class="page-bottom clearfix">
  <div class="row">
   <p class="copyright">Copyright &copy; 2015
Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a>,&nbsp; 
Theme used <a target="_blank" href="http://github.com">GitHub CSS</a>.</p>
  </div>
</div>

        </section>
      </div>
    </div>

  
    

    <script src="asset/js/foundation.min.js"></script>
    <script>
      $(document).foundation();
      function fixSidebarHeight(){
        var w1 = $('.markdown-body').height();
          var w2 = $('#sidebar').height();
          if (w1 > w2) { $('#sidebar').height(w1); };
      }
      $(function(){
        fixSidebarHeight();
      })
      $(window).load(function(){
          fixSidebarHeight();
      });
     
    </script>

    



  </body>
</html>
